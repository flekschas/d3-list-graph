/* Copyright Fritz Lekschas: D3 example visualization app using list-based graphs */
var ListGraph=function(t,s){"use strict";function i(t){var s=typeof t;return!!t&&("object"==s||"function"==s)}function e(t){for(var s=[],i=t.length;i--;)s.push({id:t[i]});return s}function l(t,s){function i(t,s,e){e(t,s);for(var l=t.parent.length;l--;)i(t.parent[l],t,e)}for(var e=t.parent.length;e--;)i(t.parent[e],t,s)}function n(t,s){s(t);for(var i=t.childRefs.length;i--;)n(t.childRefs[i],s)}function a(t,s,i){i?(l(t,s),n(t,i)):(l(t,s),n(t,s))}var o={};o.classCallCheck=function(t,s){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")},o.createClass=function(){function t(t,s){for(var i=0;i<s.length;i++){var e=s[i];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(s,i,e){return i&&t(s.prototype,i),e&&t(s,e),s}}(),o.inherits=function(t,s){if("function"!=typeof s&&null!==s)throw new TypeError("Super expression must either be null or a function, not "+typeof s);t.prototype=Object.create(s&&s.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),s&&(Object.setPrototypeOf?Object.setPrototypeOf(t,s):t.__proto__=s)},o.possibleConstructorReturn=function(t,s){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!s||"object"!=typeof s&&"function"!=typeof s?t:s};var r="scrollbar",c=function G(t,i,e){var l=this;o.classCallCheck(this,G),this.visData=i,this.width=e,this.selection=t.append("rect").attr("class",r).call(function(t){t.each(function(t,i){s.select(this.parentNode).datum().scrollbar.el=this})}).attr("x",function(t){return t.scrollbar.x}).attr("y",function(t){return t.scrollbar.y}).attr("width",function(t){return l.width}).attr("height",function(t){return t.scrollbar.height}).attr("rx",this.width/2).attr("ry",this.width/2).classed("ready",!0)},h="list-graph",u=6,d=5,g=5,v="",p=250,f="bar",b=function q(t,s,i,e){function l(t,s,i){t.attr("x",n.nodeData.x+n.visData.global.column.padding+n.visData.global.cell.padding).attr("y",function(t,s){return n.visData.global.row.padding+n.visData.global.row.contentHeight/2+n.height*s+n.visData.global.cell.padding*(1+2*s)}).attr("width",function(t){return(i?t.value:1)*(n.visData.global.column.contentWidth-2*n.visData.global.cell.padding)}).attr("height",n.height).classed(s,!0)}o.classCallCheck(this,q);var n=this;this.data=s,this.nodeData=i,this.visData=e,this.height=this.visData.global.row.contentHeight/(2*this.data.length)-2*this.visData.global.cell.padding,this.selection=t.selectAll(f).data(this.data).enter().append("g").attr("class",function(t){return f+" "+t.id}),this.selection.append("rect").call(l,"bar-border"),this.selection.append("rect").call(l,"bar-magnitude",!0)},m="bars",y=function J(t,i){o.classCallCheck(this,J);var e=this;this.visData=i,t.append("g").attr("class",m).call(function(t){t.each(function(t){new b(s.select(this),t.data.bars,t,e.visData)})})},k="links",D="link",w=function(){function t(i,e,l){var n=this;o.classCallCheck(this,t),this.visData=e,this.layout=l,this.groups=i.append("g").attr("class",k).call(function(t){t.each(function(t,i){s.select(this.parentNode).datum().links=this})}),this.links=this.groups.selectAll(D).data(function(t,s){return n.layout.links(s)}).enter().append("path").attr("class","link").attr("d",this.diagonal)}return o.createClass(t,[{key:"highlight",value:function(t,s){this.links.data(t,function(t){return t.id}).classed("highlight",s===!1?!1:!0)}},{key:"scroll",value:function(t,s){t.data(s).attr("d",this.diagonal).exit().remove()}},{key:"sort",value:function(t){var i=function(){s.select(this).classed("sorting",!0)},e=function(){s.select(this).classed("sorting",!1)};this.links.data(t,function(t){return t.id}).transition().duration(p).attr("d",this.diagonal).each("start",i).each("end",e)}},{key:"diagonal",get:function(){var t=this;return s.svg.diagonal().source(function(s){return{x:s.source.node.y+s.source.offsetY+t.visData.global.row.height/2,y:s.source.node.x+s.source.offsetX+t.visData.global.column.contentWidth+t.visData.global.column.padding}}).target(function(s){return{x:s.target.node.y+s.target.offsetY+t.visData.global.row.height/2,y:s.target.node.x+s.target.offsetX+t.visData.global.column.padding}}).projection(function(t){return[t.y,t.x]})}}]),t}(),C="nodes",x="node",E="clone",S=function(){function t(i,e,l,n){var a=this;o.classCallCheck(this,t);var r=this;this.visData=e,this.links=l,this.events=n,this.groups=i.append("g").attr("class",C).call(function(t){t.each(function(t,i){s.select(this.parentNode).datum().nodes=this})}),this.nodes=this.groups.selectAll("."+x).data(function(t){return t.rows}).enter().append("g").classed(x,!0).classed(E,function(t){return t.clone}).attr("transform",function(t){return"translate(0, "+t.y+")"}),this.nodes.append("rect").attr("x",function(t){return t.x+a.visData.global.column.padding}).attr("y",function(t){return a.visData.global.row.padding}).attr("width",this.visData.global.column.contentWidth).attr("height",this.visData.global.row.contentHeight).attr("rx",2).attr("ry",2).classed("bg",!0),this.nodes.on("click",function(t){r.mouseClick(this,t)}),this.nodes.on("mouseenter",function(t){r.mouseEnter(this,t)}),this.nodes.on("mouseleave",function(t){r.mouseLeave(this,t)}),this.nodes.call(function(t){t.append("foreignObject").attr("x",function(t){return t.x+a.visData.global.column.padding+a.visData.global.cell.padding}).attr("y",function(t){return a.visData.global.row.padding+a.visData.global.cell.padding}).attr("width",a.visData.global.column.contentWidth).attr("height",a.visData.global.row.contentHeight/2-2*a.visData.global.cell.padding).attr("class","label-wrapper").append("xhtml:div").attr("class","label").attr("title",function(t){return t.data.name}).append("xhtml:span").text(function(t){return t.data.name})}),this.bars=new y(this.nodes,this.visData)}return o.createClass(t,[{key:"mouseClick",value:function(t,s){this.events.broadcast("d3ListGraphNodeClick",{id:s.id})}},{key:"mouseEnter",value:function(t,s){var i=this;this.currentlyHighlightedLinks=[];var l=function(t,s){t.hovering=2;for(var e=t.links.length;e--;)t.links[e].target.node.id===s.id&&i.currentlyHighlightedLinks.push(t.links[e].id)},n=function(t){t.hovering=2;for(var s=t.links.length;s--;)i.currentlyHighlightedLinks.push(t.links[s].id)};a(s,l,n),s.clone&&(a(s.originalNode,l,n),s.originalNode.hovering=1),s.hovering=1,this.nodes.classed("hovering-directly",function(t){return 1===t.hovering}),this.nodes.classed("hovering-indirectly",function(t){return 2===t.hovering}),this.links.highlight(e(this.currentlyHighlightedLinks)),this.events.broadcast("d3ListGraphNodeEnter",{id:s.id})}},{key:"mouseLeave",value:function(t,s){var i=function(t){return t.hovering=0};s.hovering=0,a(s,i),s.clone&&(s.originalNode.hovering=0,a(s.originalNode,i)),this.nodes.classed("hovering-directly",!1),this.nodes.classed("hovering-indirectly",!1),this.links.highlight(e(this.currentlyHighlightedLinks),!1),this.events.broadcast("d3ListGraphNodeLeave",{id:s.id})}},{key:"sort",value:function(t){for(var i=t.length;i--;){var e=function(){s.select(this).classed("sorting",!0)},l=function(){s.select(this).classed("sorting",!1)};this.nodes.data(t[i].rows,function(t){return t.id}).transition().duration(p).attr("transform",function(t){return"translate(0, "+t.y+")"}).each("start",e).each("end",l)}}}]),t}(),T="column",H="scroll-container",M=function(){function t(s,i){var e=this;o.classCallCheck(this,t),this.visData=i,this.groups=s.selectAll("g").data(this.visData.nodes).enter().append("g").attr("class",T),this.groups.append("rect").attr("class",H).attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("width",function(t){return e.visData.global.column.width}).attr("height",function(t){return e.visData.global.column.height})}return o.createClass(t,[{key:"scrollPreparation",value:function(t,i){var e=this;this.groups.each(function(l,n){var a=l.nodes.getBoundingClientRect().height+2*e.visData.global.row.padding,o=a-e.visData.global.column.height,r=o>0?Math.max(e.visData.global.column.height*e.visData.global.column.height/a,10):0;l.height=a,l.linkSelections={incoming:n>0?t.selectByColumn(n-1,".link"):null,outgoing:t.selectByColumn(n,".link")},l.scrollHeight=o,l.scrollTop=0,l.scrollbar={el:void 0,x:l.x+e.visData.global.column.width-i,y:0,width:i,height:r,scrollHeight:e.visData.global.column.height-r,scrollTop:0,heightScale:s.scale.linear().domain([0,o]).range([0,e.visData.global.column.height-r])},l.invertedHeightScale=l.scrollbar.heightScale.invert})}},{key:"height",get:function(){return this.visData.global.column.height}}]),t}(),N="div",P="top-bar",L="ul",W="controls",O=function(){function t(i,e,l){var n=this;o.classCallCheck(this,t);var a=this;this.vis=i,this.visData=l,this.el=e.select("."+P),this.el.empty()&&(this.el=e.insert(N,":first-child").attr("class",P)),this.controls=this.el.selectAll(W).data(l.nodes).enter().append(L).classed(W,!0).style("width",this.visData.global.column.width+"px"),this.controls.append("li").attr("class","toggle").style("width",this.visData.global.column.padding+"px").on("click",this.toggleColumn),this.controls.append("li").attr("class","sort-precision ease-all").style({width:this.visData.global.column.contentWidth/2+"px",left:this.visData.global.column.padding+"px"}).on("click",function(t,s){a.sortColumn(this,s,"precision")}).on("mouseenter",function(){a.highlightBars(this.parentNode,"precision"),s.select(this).style("width",a.visData.global.column.contentWidth-16+"px")}).on("mouseleave",function(){a.highlightBars(this.parentNode,"precision",!0),s.select(this).style("width",a.visData.global.column.contentWidth/2+"px")}).html('<div class="expandable-label">  <span class="letter abbr">P</span>  <span class="letter abbr">r</span>  <span class="letter">e</span>  <span class="letter abbr">c</span>  <span class="letter">i</span>  <span class="letter">s</span>  <span class="letter">i</span>  <span class="letter">o</span>  <span class="letter">n</span></div><svg class="icon-unsort invisible-default visible">  <use xlink:href="'+this.vis.iconPath+'#unsort"></use></svg><svg class="icon-sort-asc invisible-default">  <use xlink:href="'+this.vis.iconPath+'#sort-asc"></use></svg><svg class="icon-sort-desc invisible-default">  <use xlink:href="'+this.vis.iconPath+'#sort-desc"></use></svg>'),this.controls.append("li").attr("class","sort-recall ease-all").style({width:this.visData.global.column.contentWidth/2+"px",left:this.visData.global.column.contentWidth/2+this.visData.global.column.padding+"px"}).on("click",function(t,s){a.sortColumn(this,s,"recall")}).on("mouseenter",function(){a.highlightBars(this.parentNode,"recall"),s.select(this).style({width:a.visData.global.column.contentWidth-16+"px",left:a.visData.global.column.padding+16+"px"})}).on("mouseleave",function(){a.highlightBars(this.parentNode,"recall",!0),s.select(this).style({width:a.visData.global.column.contentWidth/2+"px",left:a.visData.global.column.contentWidth/2+a.visData.global.column.padding+"px"})}).html('<div class="expandable-label">  <span class="letter abbr">R</span>  <span class="letter">e</span>  <span class="letter abbr">c</span>  <span class="letter">a</span>  <span class="letter abbr">l</span>  <span class="letter">l</span></div><svg class="icon-unsort invisible-default visible">  <use xlink:href="'+this.vis.iconPath+'#unsort"></use></svg><svg class="icon-sort-asc invisible-default">  <use xlink:href="'+this.vis.iconPath+'#sort-asc"></use></svg><svg class="icon-sort-desc invisible-default">  <use xlink:href="'+this.vis.iconPath+'#sort-desc"></use></svg>'),this.controls.append("li").attr("class","options").style("width",this.visData.global.column.padding+"px").on("click",this.toggleOptions).html('<svg class="icon-gear">  <use xlink:href="'+this.vis.iconPath+'#gear"></use></svg>'),this.sorting={},this.controls.each(function(t,s){n.sorting[s]={type:void 0,order:0,el:void 0}})}return o.createClass(t,[{key:"toggleColumn",value:function(){console.log("Toggle column")}},{key:"selectNodesColumn",value:function(t){return this.vis.selectByColumn(s.select(t).datum().level,".node")}},{key:"highlightBars",value:function(t,s,i){var e=this.selectNodesColumn(t);e.selectAll(".bar."+s).classed("highlight",!i)}},{key:"sortColumn",value:function(t,i,e){this.sorting[i].el&&this.sorting[i].type!==e&&(this.sorting[i].el.select(".icon-sort-desc").classed("visible",!1),this.sorting[i].el.select(".icon-sort-asc").classed("visible",!1),this.sorting[i].el.select(".icon-unsort").classed("visible",!0)),this.sorting[i].el=s.select(t),this.sorting[i].type=e,-1===this.sorting[i].order?(this.sorting[i].order=1,this.sorting[i].el.select(".icon-sort-desc").classed("visible",!1),this.sorting[i].el.select(".icon-sort-asc").classed("visible",!0)):(this.sorting[i].order=-1,this.sorting[i].el.select(".icon-sort-asc").classed("visible",!1),this.sorting[i].el.select(".icon-sort-desc").classed("visible",!0)),this.sorting[i].el.select(".icon-unsort").classed("visible",!1),this.vis.sortColumn(i,e,this.sorting[i].order)}},{key:"toggleOptions",value:function(){console.log("Toggle options")}}]),t}(),Y=function(t){function s(t){o.classCallCheck(this,s);var i=o.possibleConstructorReturn(this,Object.getPrototypeOf(s).call(this,t));return i.name=i.constructor.name,i.message=t,Error.captureStackTrace(i,i.constructor.name),i}return o.inherits(s,t),s}(Error),j=function(t){function s(t){return o.classCallCheck(this,s),o.possibleConstructorReturn(this,Object.getPrototypeOf(s).call(this,t||"D3.layout.listGraph.js has not been loaded yet."))}return o.inherits(s,t),s}(Y),B=function(t){function s(t){return o.classCallCheck(this,s),o.possibleConstructorReturn(this,Object.getPrototypeOf(s).call(this,t||"Dispatcher needs to be a function."))}return o.inherits(s,t),s}(Y),R=function(){function t(s,i){if(o.classCallCheck(this,t),i&&"function"!=typeof i)throw new B;this.el=s,this.dispatch=i?i:this._dispatchEvent}return o.createClass(t,[{key:"_dispatchEvent",value:function(t,s){var i=document.createEvent("CustomEvent");i.initCustomEvent(t,!1,!1,s),this.el.dispatchEvent(i)}},{key:"broadcast",value:function(t,s){this.dispatch(t,s)}}]),t}(),A=function(){function e(l,n,a,r){var p=this;if(o.classCallCheck(this,e),!s.layout.listGraph)throw new j;i(r)||(r={});var f=this;this.baseEl=l,this.baseElD3=s.select(l),this.baseElJq=t(l),this.svgD3=this.baseElD3.select("svg.base"),this.svgD3.empty()?(this.svgD3=this.baseElD3.append("svg").attr("class","base"),this.svgJq=t(this.svgD3[0])):this.svgJq=t(this.svgD3[0]),this.rootNodes=a,this.width=r.width||this.svgJq.width(),this.height=r.height||this.svgJq.height(),this.scrollbarWidth=r.scrollbarWidth||u,this.columns=r.columns||d,this.rows=r.rows||g,this.iconPath=r.iconPath||v,this.events=new R(this.baseEl,r.dispatcher),this.baseElJq.width(this.width).addClass(h),this.layout=new s.layout.listGraph([this.width,this.height],[this.columns,this.rows]),this.data=n,this.visData=this.layout.process(this.data,this.rootNodes),this.topbar=new O(this,this.baseElD3,this.visData),this.svgD3.attr("viewBox","0 0 "+this.width+" "+this.height),this.container=this.svgD3.append("g"),this.columns=new M(this.container,this.visData),this.links=new w(this.columns.groups,this.visData,this.layout),this.nodes=new S(this.columns.groups,this.visData,this.links,this.events),this.columns.scrollPreparation(this,this.scrollbarWidth),this.scrollbars=new c(this.columns.groups,this.visData,this.scrollbarWidth),this.$levels=t(this.columns.groups[0]).on("mousewheel",function(t){f.mousewheelColumn(this,t)}),this.scrollbars.selection.on("mousedown",function(){f.scrollbarMouseDown(this,s.event)}),s.select(document).on("mouseup",function(){p.globalMouseUp(s.event)}).on("mousemove",function(){p.globalMouseMove(s.event)})}return o.createClass(e,[{key:"globalMouseUp",value:function(t){if(this.activeScrollbar){var s=this.activeScrollbar.datum(),i=s.scrollbar.clientY-t.clientY;s.scrollbar.scrollTop=Math.min(Math.max(s.scrollbar.scrollTop-i,0),s.scrollbar.scrollHeight),s.scrollTop=Math.max(Math.min(s.scrollTop+s.invertedHeightScale(i),0),-s.scrollHeight),this.activeScrollbar.classed("active",!1),this.activeScrollbar=void 0}}},{key:"globalMouseMove",value:function(t){if(this.activeScrollbar){var s=this.activeScrollbar.datum(),i=s.scrollbar.clientY-t.clientY;e.scrollY(this.activeScrollbar.node(),Math.min(Math.max(s.scrollbar.scrollTop-i,0),s.scrollbar.scrollHeight));var l=Math.max(Math.min(s.scrollTop+s.invertedHeightScale(i),0),-s.scrollHeight);e.scrollY(s.nodes,l),this.links.scroll(s.linkSelections.outgoing,this.layout.offsetLinks(s.level,l,"source")),this.links.scroll(s.linkSelections.incoming,this.layout.offsetLinks(s.level-1,l,"target"))}}},{key:"scrollbarMouseDown",value:function(t,i){this.activeScrollbar=s.select(t).classed("active",!0),this.activeScrollbar.datum().scrollbar.clientY=i.clientY}},{key:"mousewheelColumn",value:function(t,i){i.preventDefault();var l=s.select(t).datum();l.scrollHeight>0&&(l.scrollTop=Math.max(Math.min(l.scrollTop+i.deltaY,0),-l.scrollHeight),e.scrollY(l.nodes,l.scrollTop),l.scrollbar.scrollTop=l.scrollbar.heightScale(-l.scrollTop),e.scrollY(l.scrollbar.el,l.scrollbar.scrollTop),this.links.scroll(l.linkSelections.outgoing,this.layout.offsetLinks(l.level,l.scrollTop,"source")),this.links.scroll(l.linkSelections.incoming,this.layout.offsetLinks(l.level-1,l.scrollTop,"target")))}},{key:"selectByColumn",value:function(t,i){return s.select(this.columns.groups[0][t]).selectAll(i)}},{key:"sortColumn",value:function(t,s,i){this.nodes.sort(this.layout.sort(t,s,i).nodes(t)),this.links.sort(this.layout.links(t-1,t+1))}}],[{key:"scrollY",value:function(t,i){s.select(t).attr("transform","translate(0, "+i+")")}}]),e}();return A}($,d3);
//# sourceMappingURL=listGraph.min.js.map
